---
title: "Final Project"
author: "Yiwei Gong, Brian Cozzi, Eric Su, Peter Kim"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---



```{r Setup, include=FALSE}
library(dplyr)
library(jsonlite)
#library(janitor)
library(tidyverse)
library(plyr)
library(RCurl)
```

# Preparation  

## Get Red Light and Traffic Data  
```{r Red Lights}

first.date = as.Date("2014-07-01")
last.date = as.Date("2018-11-26")

json.files = seq.Date(first.date, last.date, "day")

make.df = function(list){
  
  df = data_frame(
    address = list$address,
    camera_id = list$camera_id,
    intersection = list$intersection,
    violation_date = list$violation_date,
    violations = list$violations,
    latitutde = list$latitude,
    longitude = list$longitude,
    x_coordinate = list$x_coordinate,
    y_coordinate = list$y_coordinate
  )
    
  return(df)
}

get.redlight.data = function(date){
  day = format(date, "%d")
  month = format(date, "%m")
  year = format(date, "%Y")
  data = fromJSON(paste0(
    "https://data.cityofchicago.org/resource/twfh-866z.json?violation_date=",
    year,
    "-", 
    month, 
    "-", 
    day,
    "T00:00:00.000")
    )
  return(data)
}

redlight_data = map(json.files, get.redlight.data) %>%
  ldply(.fun = make.df)

saveRDS(redlight_data, file = "red_light_test.Rds")
```


```{r Traffic Data}
offsets = seq(0, 19000000, by = 50000)
get.traffic = function(offset){
  base.url = paste0("https://data.cityofchicago.org/resource/chicago-traffic-tracker-historical-congestion-estimates-by-segment.json?$limit=50000&$offset=",
                    offset%>% as.integer())
  return(fromJSON(base.url))
}

Traffic = map_df(offsets, get.traffic)

Segments = fromJSON(
  "https://data.cityofchicago.org/resource/8v9j-bter.json?$limit=5000"
  ) %>% 
  unique() 
  
offsets = seq(0, 19000000, by = 50000)
get.traffic = function(offset){
  base.url = paste0("https://data.cityofchicago.org/resource/chicago-traffic-tracker-historical-congestion-estimates-by-segment.json?$limit=50000&$offset=",
                    offset%>% as.integer())
  return(fromJSON(base.url))
}

Traffic = map_df(offsets, get.traffic)

Segments = fromJSON(
  "https://data.cityofchicago.org/resource/8v9j-bter.json?$limit=5000"
) %>% 
  unique() 

Segments = Segments %>%
  mutate(start_lon = as.numeric(start_lon),
         start_lat = as.numeric(Segments$`_lif_lat`),
         end_lon = as.numeric(Segments$`_lit_lon`),
         end_lat = as.numeric(Segments$`_lit_lat`),
         direction = Segments$`_direction`,
         length = Segments$`_length`
  ) %>% 
  select(segmentid,direction, street, start_lon, start_lat,
         end_lon, end_lat, length, length)

Traffic = Traffic %>% mutate(
  last_update = as.POSIXct(last_update, format = "%Y-%m-%dT%H:%M:%S"),
  bus_count = as.integer(bus_count),
  msg_count = as.integer(msg_count),
  traffic = as.integer(traffic))

Traffic = Traffic %>% 
  inner_join(., Segments, by = c("segment_id" = "segmentid"))


saveRDS(Traffic, file = "traffic.Rds")

```




## Get Darksky Weather Data  

Intuitively, the traffic situation could be closely related to the weather on that day, which may further influence the number of red light violations. In this section we used information from Darksky to get all the weather reports from 2014-07-01(starting date of red violation data) to 2018-11-25(newest update). The main function get_darksky_weather uses the API key and date, combined with the base_url to get the url for API call. After a json file is obtained from this url, a dataframe about hourly weather and a dataframe of daily weather are created, using  function get_weather_df_daily and get_weather_df_hourly respectively. The function get_weather_hourly uses the list from the json file to build a dataframe with temperature, apparent temperature, precipitation type, visibility uv index and cloud.The function get_weather_daily uses the same list to store information about the weather, temperature (high and low), apparent temperature(high and low), visibility, cloud and uv index. These variables could be of interest for further modelling. For example, traffic is likely to get crowded in a sunny day near beaches according to a local's experience. We then map a vector of dates with the main function, getting a list with size 1609 (the number of days). Hourly information and daily information are obtained accordingly from the main list. (Two API keys are used because of the call limit.)  


```{r darksky}
### Powered by Darksky

# Function
# extract weather information from a given list
get_weather_df_hourly = function(ls){
  
  hourly = ls$hourly
  
  hourly_data = hourly$data
  
  dataframe = data_frame(
    time = as.POSIXct(hourly_data$time, 
                      origin="1970-01-01", tz = "America/Chicago"),
    temperature = hourly_data$temperature,
    apparent_temperature = hourly_data$apparentTemperature,
    precip_intensity = hourly_data$precipIntensity,
    precip_type = ifelse(precip_intensity != 0, 
                         hourly_data$precipType, 
                         NA),
    visibility = hourly_data$visibility,
    uvIndex = hourly_data$uvIndex,
    cloud = hourly_data$cloudCover
  )
  
  return(dataframe)
}

get_weather_daily = function(ls){
  
  daily = ls$daily$data
  
  preint = daily$precip_intensity
  
  df = data_frame(
    time = as.POSIXct(daily$time, 
                        origin = "1970-01-01", tz="America/Chicago"),
    summary = daily$summary,
    icon = daily$icon,
    sunrise = as.POSIXct(daily$sunriseTime,
                         origin = "1970-01-01", tz="America/Chicago"),
    sunset = as.POSIXct(daily$sunsetTime, 
                        origin = "1970-01-01", tz="America/Chicago"),
    precipIntensity = daily$precipIntensity,
    precipType = ifelse(daily$precipIntensity != 0, 
                        daily$precipType, "None"),
    visibility = daily$visibility,
    uvIndex = daily$uvIndex,
    cloudCover = daily$cloudCover,
    temperatureHigh = daily$temperatureHigh,
    temperatureHighTime = as.POSIXct(daily$temperatureHighTime,
                                        origin = "1970-01-01",
                                        tz = "America/Chicago"),
    temperatureLow = daily$temperatureLow,
    temperatureLowTime = as.POSIXct(daily$temperatureLowTime,
                                       origin = "1970-01-01",
                                       tz = "America/Chicago"),
    apparentTemperatureHigh = daily$apparentTemperatureHigh,
    apperentTemperatureHighTime = as.POSIXct(
         daily$apparentTemperatureHighTime,
         origin = "1970-01-01",
         tz = "America/Chicago"),
    apparetTemperatureLow = daily$apparentTemperatureLow,
    apparentTemperatureLowTime = as.POSIXct(
         daily$apparentTemperatureLowTime,
         origin = "1970-01-01",
         tz = "America/Chicago"
       )
    
  )
  
  
#   df = daily %>%
#     mutate(precipType = ifelse(preint != 0, daily$precipType, 0)) %>%
#     select(
#       time, summary,
#       icon, sunriseTime,
#       sunsetTime, precipIntensity,
#       precipIntensityMaxTime, temperatureHigh,
#       temperatureHighTime, temperatureLow,
#       temperatureLowTime, apparentTemperatureHigh,
#       apparentTemperatureHighTime, apparentTemperatureLow,
#       apparentTemperatureLowTime, cloudCover,
#       uvIndex, visibility
#     ) %>%
#     mutate(
#       time = as.POSIXct(daily$time, 
#                         origin = "1970-01-01", tz="America/Chicago"),
#       sunrise = as.POSIXct(daily$sunriseTime, 
#                            origin = "1970-01-01", tz="America/Chicago"),
#       sunset = as.POSIXct(daily$sunsetTime, 
#                           origin = "1970-01-01", tz="America/Chicago"),
#       precipIntensityMaxTime = as.POSIXct(daily$precipIntensityMaxTime,
#                                           origin = "1970-01-01",
#                                           tz = "America/Chicago"),
#       temperatureHighTime = as.POSIXct(daily$temperatureHighTime,
#                                        origin = "1970-01-01",
#                                        tz = "America/Chicago"),
#       temperatureLowTime = as.POSIXct(daily$temperatureLowTime,
#                                       origin = "1970-01-01",
#                                       tz = "America/Chicago"),
#       apparentTemperatureHighTime = as.POSIXct(
#         daily$apparentTemperatureHighTime,
#         origin = "1970-01-01",
#         tz = "America/Chicago"),
#       apparentTemperatureLowTime = as.POSIXct(
#         daily$apparentTemperatureLowTime,
#         origin = "1970-01-01",
#         tz = "America/Chicago"
#       )
#            ) %>%
#     select(
#       -sunriseTime,
#       -sunsetTime
#     )
#   
   return(df)
 
 }


# get weather from api, location and date
get_darksky_weather = function(api, date){
  
  base_url = "https://api.darksky.net/forecast"
  
  lat = 41.8781
  
  lon = -87.6298
  
  location_time = paste(lat, lon, date, sep = ",")
  
  url = paste(base_url, api, location_time, sep = "/")
  
  json_file = getURL(url)
  
  weather_ls = fromJSON(json_file)

  weather_df_hourly = weather_ls %>%
    get_weather_df_hourly()
  
  weather_df_daily = weather_ls %>%
    get_weather_daily()
  
  sunrise = weather_df_daily$sunrise
  
  sunset = weather_df_daily$sunset
  
  weather_df_hourly = weather_df_hourly %>%
    mutate(
      daytime = ifelse(sunrise <= time & time <= sunset, 1, 0))
  
  return(list(weather_df_hourly, weather_df_daily))
}

# Timing

beginning_date = as.Date("2014-07-01")

end_date = as.Date("2018-11-26")

date_range = seq(beginning_date, end_date, by = 1)

date_range = paste0(date_range, "T00:00:00") %>%
  as.list()

# get all days data

api1 = "af3059a900dc8bac54230a58e8ced0b6"

#api1 = "448bbc1ae89834bb843d4d38161853f6"
api2 = "90b9b07a146dbc30c84c30cd36c0347f"

#api1 = "af3059a900dc8bac54230a58e8ced0b6"
#api1 = "7231a45cac6fe407c4d4f6269f560d92"
#api2 = "29e4dd8948446db4c8c099b2c6b63d49"


#api1 = "c0b9c2d13d2a45325b40ea828db03ad7"
#api2 = "14e33d073ddf24559841f74e0174434b"


lat = 41.8781
lon = -87.6298

n = length(date_range)

weather_900 = map(date_range[1:900], function(x)
 get_darksky_weather(api = api1, date = x))
hourly_900 = map_dfr(weather_900, function(x) x[[1]])
daily_900 = map_dfr(weather_900, function(x) x[[2]])

weather_after = map(date_range[900:n], function(x)
 get_darksky_weather(api= api2, date = x))
hourly_after = map_dfr(weather_after, function(x) x[[1]])
daily_after = map_dfr(weather_after, function(x) x[[2]])

weather_info_hourly = rbind(hourly_900, hourly_after)
weather_info_daily = rbind(daily_900, daily_after)


saveRDS(weather_info_daily, file = "weather_info_daily.Rds")
saveRDS(weather_info_hourly, file = "weather_info_hourly.Rds")

## weather_info_daily = readRDS("weather_info_daily.Rds")
## weather_info_hourly = readRDS("hourly_info_daily.Rds")
```


```{r, data cleaning}
redlight_data = redlight_data %>% 
  transmute(date         = as.POSIXct(violation_date, format = "%Y-%m-%dT%H:%M:%S") %>% ymd(),
            address      = factor(address),
            camera_id    = factor(camera_id),
            intersection = factor(intersection),
            violations   = as.numeric(violations),
            latitutde    = as.numeric(latitutde),
            longitude    = as.numeric(longitude),
            x_coordinate = as.numeric(x_coordinate),
            y_coordinate = as.numeric(y_coordinate)) %>%
  distinct() %>%
  na.omit()


#dont tun the code below!!! 
##############################################################
Traffic_test = Traffic %>%
  transmute(date       = as.POSIXct(last_update %>% 
                                      as.character(), 
                                    format = "%Y-%m-%d") %>% ymd(),
            segment_id = factor(segment_id),
            bus_count  = bus_count,
            msg_count  = msg_count,
            traffic    = traffic,
            direction  = factor(direction),
            street     = factor(street),
            latitude   = (start_lat + end_lat) / 2,
            longitude  = (start_lon + end_lon) / 2,
            length     = as.numeric(length)) %>% 
  distinct() %>%
  na.omit()

Traffic_test2 = Traffic_test %>%
  group_by(segment_id, date) %>%
  dplyr::summarise(bus_count = median(bus_count, na.rm = T),
                   msg_count = median(msg_count, na.rm = T),
                   traffic   = median(traffic, na.rm = T))
Traffic_test3 = Traffic_test %>%
  select(-bus_count, -msg_count, -traffic) %>%
  distinct()

Traffic_test4 = left_join(Traffic_test2, Traffic_test3)

haversine_dist = function(lat1, long1, lat2, long2){
  lat1  = lat1  * 0.0174532925
  lat2  = lat2  * 0.0174532925
  long1 = long1 * 0.0174532925
  long2 = long2 * 0.0174532925
  return(12742 * asin(sqrt((sin((lat2-lat1)/2)^2 + cos(lat1)* cos(lat2)* (sin((long2-long1)/2)^2)))))
}

nearest = function(lat, long, locations){
  distances = pmap(locations, function(latitude, longitude)
    {haversine_dist(lat, long, latitude, longitude)})
  return(min(unlist(distances)))
}

distinct_camera = redlight_data %>% select(latitude, longitude) %>% distinct()
distinct_segment = Traffic_test %>% select(segment_id, latitude, longitude) %>% distinct()


min_distances = pmap(redlight_data[, c("latitude","longitude")],
                      function(latitude, longitude)
                        {nearest(latitude, longitude, Traffic[, c("latitude","longitude")])}) %>% 
                 unlist()

#not done, don't run the code below
a = left_join(redlight_data, data.frame(min_distances, distinct_camera))
b = left_join(a, Traffic_test, by = c("min_distances" = "segment_id", "date"))

###############################################################

weather_temp = bind_rows(daily_900, daily_after) %>%
  mutate(time = as.Date(time))
data_tidy = left_join(redlight_data, weather_temp, by = c("date" = "time")) %>%
  mutate(icon = factor(icon),
         precipType = factor(precipType), 
         day_in_week = weekdays(date),
         Month = month(date))

```


# Generate a Predictive model by intersection  
```{r}
library(gbm)
gbm_model = gbm(violations ~ longitude + latitude + icon + precipIntensity + 
                  temperatureHigh + temperatureLow + apparentTemperatureHigh +
                  apparentTemperatureLow + cloudCover + uvIndex + visibility + day_in_week +
                  Month, data = data_tidy, distribution = "poisson",
                shrinkage = 0.46503859, interaction.depth = 3, n.minobsinnode = 17, 
                n.trees = 1799)


```


# Shiny App  
```{r shiny app}
library(shiny)
library(purrr)
library(lubridate)

shinyApp(
  ui = fluidPage(
    titlePanel(""),
    sidebarLayout(
      sidebarPanel(
        
        selectInput("month", label = h3("Month Input"),
                    choices = 1:12,
                    selected = 1),
        
        selectInput("dayofweek", label = h3("Day of the Week Input"),
                    choices = c("Monday", "Tuesday", "Wednesday",
                                "Thursday", "Friday", "Saturday", 
                                "Sunday"),
                    selected = "Monday"),
        
        actionButton("action", label = "Get heat map")
        
      ),
      
      mainPanel(
        uiOutput("links")
      )
      
    )
  ),
  
  server = function(input, output, session){
    
    state = reactiveValues(
      observers = list()
    )

    observeEvent( input$action, {
      
        
      # Destroy existing observers
      for(i in seq_along(state$observers)) {
        state$observers[[i]]$destroy()
      }
        
      ui_elems = 
        
          map(seq_len(nrow(nyt.headline)),
            function(i) fluidRow(actionLink(
              paste0("link", i),
              paste0(i, ". ", nyt.headline[i, "Headline"])))
        )
      
      output$links = renderUI(fluidPage(ui_elems))
      
      # Reset and create new observers for each of our links
      state$observers = map(
        seq_len(nrow(nyt.headline)), 
        function(i) {
          label = paste0("link",i)
          observeEvent(
            input[[label]], 
            {
          
            }, 
            ignoreInit = TRUE
          )
        }
      )
      
      
      
    })
  }
)

```

